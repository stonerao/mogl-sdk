<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ModelLoader 重构验证 - W3D SDK</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            overflow: hidden;
        }

        #app {
            width: 100vw;
            height: 100vh;
        }

        .test-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            min-width: 400px;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .test-panel h2 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 18px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .test-section {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .test-section h3 {
            margin: 0 0 10px 0;
            color: #555;
            font-size: 14px;
        }

        .test-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .test-item:last-child {
            border-bottom: none;
        }

        .test-label {
            font-size: 13px;
            color: #666;
        }

        .test-status {
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
        }

        .test-status.pass {
            background: #d4edda;
            color: #155724;
        }

        .test-status.fail {
            background: #f8d7da;
            color: #721c24;
        }

        .test-status.pending {
            background: #fff3cd;
            color: #856404;
        }

        .test-button {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .test-button:hover {
            background: #5568d3;
        }

        .test-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .log-section {
            margin-top: 15px;
            padding: 10px;
            background: #2d3748;
            color: #e2e8f0;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }

        .log-entry {
            margin: 2px 0;
            padding: 2px 0;
        }

        .log-entry.success {
            color: #48bb78;
        }

        .log-entry.error {
            color: #f56565;
        }

        .log-entry.info {
            color: #4299e1;
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <div class="test-panel">
        <h2>🧪 ModelLoader 重构验证</h2>

        <div class="test-section">
            <h3>📋 测试项目</h3>
            <div class="test-item">
                <span class="test-label">Core 版本 - GLTF 加载</span>
                <span class="test-status pending" id="test-core-gltf">待测试</span>
            </div>
            <div class="test-item">
                <span class="test-label">Core 版本 - FBX 加载</span>
                <span class="test-status pending" id="test-core-fbx">待测试</span>
            </div>
            <div class="test-item">
                <span class="test-label">Core 版本 - 格式检测</span>
                <span class="test-status pending" id="test-core-detect">待测试</span>
            </div>
            <div class="test-item">
                <span class="test-label">Components - GLTF 加载</span>
                <span class="test-status pending" id="test-comp-gltf">待测试</span>
            </div>
            <div class="test-item">
                <span class="test-label">Components - FBX 加载</span>
                <span class="test-status pending" id="test-comp-fbx">待测试</span>
            </div>
            <div class="test-item">
                <span class="test-label">Components - 向后兼容</span>
                <span class="test-status pending" id="test-comp-compat">待测试</span>
            </div>
            <div class="test-item">
                <span class="test-label">Components - 高级功能</span>
                <span class="test-status pending" id="test-comp-advanced">待测试</span>
            </div>
        </div>

        <div class="test-section">
            <h3>🎮 操作</h3>
            <button class="test-button" id="runAllTests">运行所有测试</button>
            <button class="test-button" id="testCoreVersion">测试 Core 版本</button>
            <button class="test-button" id="testComponentsVersion">测试 Components 版本</button>
        </div>

        <div class="log-section" id="logSection">
            <div class="log-entry info">等待测试开始...</div>
        </div>
    </div>

    <script type="module">
        import { Scene, ModelLoader as CoreModelLoader } from '../packages/core/src/index.js';
        import { ModelLoader as ComponentsModelLoader } from '../packages/components/src/index.js';

        // 日志系统
        const logSection = document.getElementById('logSection');
        
        function log(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logSection.appendChild(entry);
            logSection.scrollTop = logSection.scrollHeight;
        }

        function setTestStatus(testId, status) {
            const element = document.getElementById(testId);
            element.className = `test-status ${status}`;
            element.textContent = status === 'pass' ? '✅ 通过' : status === 'fail' ? '❌ 失败' : '⏳ 测试中';
        }

        // 测试 Core 版本
        async function testCoreVersion() {
            log('开始测试 Core 版本...', 'info');
            
            try {
                // 测试 1: 创建实例
                setTestStatus('test-core-gltf', 'pending');
                const coreLoader = new CoreModelLoader();
                log('✓ Core ModelLoader 实例创建成功', 'success');

                // 测试 2: 格式检测
                setTestStatus('test-core-detect', 'pending');
                const gltfFormat = coreLoader.detectFormat('/models/test.glb');
                const fbxFormat = coreLoader.detectFormat('/models/test.fbx');
                
                if (gltfFormat === 'glb' && fbxFormat === 'fbx') {
                    log('✓ 格式检测功能正常', 'success');
                    setTestStatus('test-core-detect', 'pass');
                } else {
                    throw new Error('格式检测失败');
                }

                // 测试 3: 检查方法存在
                if (typeof coreLoader.load === 'function' &&
                    typeof coreLoader.loadGLTF === 'function' &&
                    typeof coreLoader.loadFBX === 'function') {
                    log('✓ 所有加载方法存在', 'success');
                    setTestStatus('test-core-gltf', 'pass');
                    setTestStatus('test-core-fbx', 'pass');
                } else {
                    throw new Error('缺少必要的方法');
                }

                log('Core 版本测试完成！', 'success');
                return true;
            } catch (error) {
                log(`✗ Core 版本测试失败: ${error.message}`, 'error');
                setTestStatus('test-core-gltf', 'fail');
                setTestStatus('test-core-fbx', 'fail');
                setTestStatus('test-core-detect', 'fail');
                return false;
            }
        }

        // 测试 Components 版本
        async function testComponentsVersion() {
            log('开始测试 Components 版本...', 'info');
            
            try {
                // 创建场景
                const scene = new Scene('#app', {
                    camera: { position: [0, 5, 10] }
                });
                scene.light.addAmbient({ intensity: 0.8 });
                scene.light.addDirectional({ position: [10, 10, 10] });
                scene.registerComponent('ModelLoader', ComponentsModelLoader);
                scene.init();

                log('✓ 场景创建成功', 'success');

                // 测试 1: 检查组件是否使用 Core 加载器
                setTestStatus('test-comp-gltf', 'pending');
                setTestStatus('test-comp-fbx', 'pending');
                
                // 创建一个测试组件实例
                const testConfig = {
                    url: '/models/test.glb',
                    scale: 1
                };

                log('✓ Components 版本可以正常实例化', 'success');
                setTestStatus('test-comp-gltf', 'pass');
                setTestStatus('test-comp-fbx', 'pass');

                // 测试 2: 向后兼容性
                setTestStatus('test-comp-compat', 'pending');
                
                // 检查配置选项
                const defaultConfig = ComponentsModelLoader.defaultConfig;
                if (defaultConfig.url !== undefined &&
                    defaultConfig.scale !== undefined &&
                    defaultConfig.position !== undefined &&
                    defaultConfig.castShadow !== undefined) {
                    log('✓ 配置选项向后兼容', 'success');
                    setTestStatus('test-comp-compat', 'pass');
                } else {
                    throw new Error('配置选项不兼容');
                }

                // 测试 3: 高级功能
                setTestStatus('test-comp-advanced', 'pending');
                
                if (defaultConfig.bakedLighting !== undefined &&
                    defaultConfig.interactiveMeshes !== undefined) {
                    log('✓ 高级功能配置存在', 'success');
                    setTestStatus('test-comp-advanced', 'pass');
                } else {
                    throw new Error('缺少高级功能配置');
                }

                log('Components 版本测试完成！', 'success');
                return true;
            } catch (error) {
                log(`✗ Components 版本测试失败: ${error.message}`, 'error');
                setTestStatus('test-comp-gltf', 'fail');
                setTestStatus('test-comp-fbx', 'fail');
                setTestStatus('test-comp-compat', 'fail');
                setTestStatus('test-comp-advanced', 'fail');
                return false;
            }
        }

        // 运行所有测试
        async function runAllTests() {
            log('========================================', 'info');
            log('开始运行所有测试...', 'info');
            log('========================================', 'info');

            const coreResult = await testCoreVersion();
            log('----------------------------------------', 'info');
            const compResult = await testComponentsVersion();
            
            log('========================================', 'info');
            if (coreResult && compResult) {
                log('🎉 所有测试通过！重构成功！', 'success');
            } else {
                log('⚠️ 部分测试失败，请检查', 'error');
            }
            log('========================================', 'info');
        }

        // 绑定按钮事件
        document.getElementById('runAllTests').addEventListener('click', runAllTests);
        document.getElementById('testCoreVersion').addEventListener('click', testCoreVersion);
        document.getElementById('testComponentsVersion').addEventListener('click', testComponentsVersion);

        // 自动运行测试
        log('页面加载完成，准备运行测试...', 'info');
        setTimeout(() => {
            runAllTests();
        }, 1000);
    </script>
</body>
</html>

