<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FBX æ¨¡å‹åŠ è½½ç¤ºä¾‹ - W3D SDK</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            overflow: hidden;
        }

        #app {
            width: 100vw;
            height: 100vh;
        }

        .controls {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            min-width: 300px;
            max-width: 400px;
        }

        .controls h2 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 18px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .control-group {
            margin-bottom: 15px;
        }

        .control-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-size: 14px;
            font-weight: 500;
        }

        .control-group button {
            width: 100%;
            padding: 10px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .control-group button:hover {
            background: #5568d3;
        }

        .control-group button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .progress-container {
            margin-top: 10px;
        }

        .progress-bar {
            width: 100%;
            height: 25px;
            background: #f0f0f0;
            border-radius: 5px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        .info {
            margin-top: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            font-size: 12px;
            color: #666;
        }

        .info-item {
            margin: 5px 0;
            display: flex;
            justify-content: space-between;
        }

        .info-label {
            font-weight: 500;
            color: #333;
        }

        .status {
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 12px;
            margin-top: 10px;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
        }

        .status.loading {
            background: #d1ecf1;
            color: #0c5460;
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <div class="controls">
        <h2>ğŸ® FBX æ¨¡å‹åŠ è½½ç¤ºä¾‹</h2>

        <div class="control-group">
            <label>é€‰æ‹©æ¨¡å‹æ ¼å¼ï¼š</label>
            <button id="loadGLTF">åŠ è½½ GLTF æ¨¡å‹</button>
        </div>

        <div class="control-group">
            <button id="loadFBX">åŠ è½½ FBX æ¨¡å‹</button>
        </div>

        <div class="control-group">
            <button id="loadBoth">åŒæ—¶åŠ è½½ä¸¤ç§æ ¼å¼</button>
        </div>

        <div class="progress-container" id="progressContainer" style="display: none;">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill">0%</div>
            </div>
        </div>

        <div id="status"></div>

        <div class="info">
            <div class="info-item">
                <span class="info-label">å·²åŠ è½½æ¨¡å‹ï¼š</span>
                <span id="modelCount">0</span>
            </div>
            <div class="info-item">
                <span class="info-label">åŠ¨ç”»æ•°é‡ï¼š</span>
                <span id="animationCount">0</span>
            </div>
            <div class="info-item">
                <span class="info-label">æ¨¡å‹ç±»å‹ï¼š</span>
                <span id="modelType">-</span>
            </div>
        </div>

        <div class="info" style="margin-top: 10px;">
            <strong>ğŸ’¡ æç¤ºï¼š</strong><br>
            â€¢ ç‚¹å‡»æ¨¡å‹å¯ä»¥æŸ¥çœ‹ä¿¡æ¯<br>
            â€¢ æ”¯æŒ GLTF/GLB/FBX æ ¼å¼<br>
            â€¢ è‡ªåŠ¨æ£€æµ‹æ¨¡å‹æ ¼å¼<br>
            â€¢ ç»Ÿä¸€çš„åŠ è½½æ¥å£
        </div>
    </div>

    <script type="module">
        import { Scene, ModelLoader } from '../packages/core/src/index.js';
        import * as THREE from 'three';

        // åˆ›å»ºåœºæ™¯
        const scene = new Scene('#app', {
            renderer: {
                antialias: true,
                alpha: false
            },
            camera: {
                position: [0, 5, 10],
                fov: 45
            },
            controls: {
                enableDamping: true,
                dampingFactor: 0.05
            }
        });

        // æ·»åŠ ç¯å…‰
        scene.light.addAmbient({
            color: '#ffffff',
            intensity: 0.6
        });

        scene.light.addDirectional({
            color: '#ffffff',
            intensity: 1.0,
            position: [10, 10, 10],
            castShadow: true
        });

        // æ·»åŠ åœ°é¢
        const groundGeometry = new THREE.PlaneGeometry(20, 20);
        const groundMaterial = new THREE.MeshStandardMaterial({
            color: '#808080',
            roughness: 0.8,
            metalness: 0.2
        });
        const ground = new THREE.Mesh(groundGeometry, groundMaterial);
        ground.rotation.x = -Math.PI / 2;
        ground.receiveShadow = true;
        scene.scene.add(ground);

        // æ³¨å†Œç»„ä»¶
        scene.registerComponent('ModelLoader', ModelLoader);

        // åˆå§‹åŒ–åœºæ™¯
        scene.init();

        // UI å…ƒç´ 
        const loadGLTFBtn = document.getElementById('loadGLTF');
        const loadFBXBtn = document.getElementById('loadFBX');
        const loadBothBtn = document.getElementById('loadBoth');
        const progressContainer = document.getElementById('progressContainer');
        const progressFill = document.getElementById('progressFill');
        const statusDiv = document.getElementById('status');
        const modelCountSpan = document.getElementById('modelCount');
        const animationCountSpan = document.getElementById('animationCount');
        const modelTypeSpan = document.getElementById('modelType');

        let loadedModels = 0;

        // æ˜¾ç¤ºçŠ¶æ€
        function showStatus(message, type = 'loading') {
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
        }

        // éšè—çŠ¶æ€
        function hideStatus() {
            statusDiv.style.display = 'none';
        }

        // æ›´æ–°è¿›åº¦
        function updateProgress(percent) {
            const percentValue = Math.round(percent * 100);
            progressFill.style.width = percentValue + '%';
            progressFill.textContent = percentValue + '%';
        }

        // ç›‘å¬åŠ è½½è¿›åº¦
        scene.resourceManager.on('resource:load:progress', (event) => {
            progressContainer.style.display = 'block';
            updateProgress(event.progress);
        });

        scene.resourceManager.on('resource:load:complete', (event) => {
            setTimeout(() => {
                progressContainer.style.display = 'none';
                updateProgress(0);
            }, 500);
        });

        // åŠ è½½ GLTF æ¨¡å‹ï¼ˆç¤ºä¾‹ - ä½¿ç”¨å ä½ç¬¦ï¼‰
        loadGLTFBtn.addEventListener('click', async () => {
            try {
                showStatus('æ­£åœ¨åŠ è½½ GLTF æ¨¡å‹...', 'loading');
                
                // æ³¨æ„ï¼šè¿™é‡Œä½¿ç”¨ç¤ºä¾‹ URLï¼Œå®é™…ä½¿ç”¨æ—¶éœ€è¦æ›¿æ¢ä¸ºçœŸå®çš„æ¨¡å‹è·¯å¾„
                const model = await scene.add('ModelLoader', {
                    name: 'gltf-model',
                    url: '/models/example.glb',  // æ›¿æ¢ä¸ºå®é™…çš„ GLTF æ¨¡å‹è·¯å¾„
                    scale: 2,
                    position: [-3, 0, 0]
                });

                setupModel(model, 'GLTF');
                showStatus('GLTF æ¨¡å‹åŠ è½½æˆåŠŸï¼', 'success');
                
            } catch (error) {
                showStatus(`åŠ è½½å¤±è´¥: ${error.message}`, 'error');
                console.error('GLTF åŠ è½½é”™è¯¯:', error);
            }
        });

        // åŠ è½½ FBX æ¨¡å‹ï¼ˆç¤ºä¾‹ - ä½¿ç”¨å ä½ç¬¦ï¼‰
        loadFBXBtn.addEventListener('click', async () => {
            try {
                showStatus('æ­£åœ¨åŠ è½½ FBX æ¨¡å‹...', 'loading');
                
                // æ³¨æ„ï¼šè¿™é‡Œä½¿ç”¨ç¤ºä¾‹ URLï¼Œå®é™…ä½¿ç”¨æ—¶éœ€è¦æ›¿æ¢ä¸ºçœŸå®çš„æ¨¡å‹è·¯å¾„
                const model = await scene.add('ModelLoader', {
                    name: 'fbx-model',
                    url: '/models/example.fbx',  // æ›¿æ¢ä¸ºå®é™…çš„ FBX æ¨¡å‹è·¯å¾„
                    scale: 0.01,  // FBX æ¨¡å‹é€šå¸¸éœ€è¦ç¼©å°
                    position: [3, 0, 0]
                });

                setupModel(model, 'FBX');
                showStatus('FBX æ¨¡å‹åŠ è½½æˆåŠŸï¼', 'success');
                
            } catch (error) {
                showStatus(`åŠ è½½å¤±è´¥: ${error.message}`, 'error');
                console.error('FBX åŠ è½½é”™è¯¯:', error);
            }
        });

        // åŒæ—¶åŠ è½½ä¸¤ç§æ ¼å¼
        loadBothBtn.addEventListener('click', async () => {
            try {
                showStatus('æ­£åœ¨åŒæ—¶åŠ è½½ GLTF å’Œ FBX æ¨¡å‹...', 'loading');
                
                const [gltfModel, fbxModel] = await Promise.all([
                    scene.add('ModelLoader', {
                        name: 'gltf-model',
                        url: '/models/example.glb',
                        scale: 2,
                        position: [-3, 0, 0]
                    }),
                    scene.add('ModelLoader', {
                        name: 'fbx-model',
                        url: '/models/example.fbx',
                        scale: 0.01,
                        position: [3, 0, 0]
                    })
                ]);

                setupModel(gltfModel, 'GLTF');
                setupModel(fbxModel, 'FBX');
                
                showStatus('æ‰€æœ‰æ¨¡å‹åŠ è½½æˆåŠŸï¼', 'success');
                
            } catch (error) {
                showStatus(`åŠ è½½å¤±è´¥: ${error.message}`, 'error');
                console.error('æ‰¹é‡åŠ è½½é”™è¯¯:', error);
            }
        });

        // è®¾ç½®æ¨¡å‹
        function setupModel(model, type) {
            loadedModels++;
            modelCountSpan.textContent = loadedModels;
            modelTypeSpan.textContent = type;

            // å¯ç”¨é˜´å½±
            model.scene.traverse((child) => {
                if (child.isMesh) {
                    child.castShadow = true;
                    child.receiveShadow = true;
                }
            });

            // æ›´æ–°åŠ¨ç”»æ•°é‡
            if (model.animations && model.animations.length > 0) {
                animationCountSpan.textContent = model.animations.length;
                
                // æ’­æ”¾ç¬¬ä¸€ä¸ªåŠ¨ç”»
                scene.animationManager.play(
                    model.scene,
                    model.animations[0],
                    { loop: THREE.LoopRepeat }
                );
            }

            // æ·»åŠ ç‚¹å‡»äº‹ä»¶
            model.on('click', (event) => {
                console.log('æ¨¡å‹è¢«ç‚¹å‡»:', {
                    name: model.name,
                    type: model.type,
                    animations: model.animations.length,
                    object: event.object
                });
                
                showStatus(`ç‚¹å‡»äº† ${type} æ¨¡å‹`, 'success');
            });

            console.log('æ¨¡å‹åŠ è½½å®Œæˆ:', {
                type: model.type,
                animations: model.animations.length,
                cameras: model.cameras.length
            });
        }

        // åˆå§‹æç¤º
        showStatus('è¯·é€‰æ‹©è¦åŠ è½½çš„æ¨¡å‹æ ¼å¼', 'loading');
        setTimeout(hideStatus, 2000);
    </script>
</body>
</html>

